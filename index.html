<script>
    const API_KEY = "AIzaSyBGhnNQNKHv9CNk_r6sNX43k0fGOQNhGkA";

    async function improveWithAI(fieldId) {
        const field = document.getElementById(fieldId);
        const originalText = field.value;
        
        if (!originalText || originalText.length < 5) {
            alert(currentLang === 'ar' ? "يرجى كتابة نص أولاً!" : "Please write something first!");
            return;
        }
        
        const btn = event.currentTarget;
        btn.classList.add('ai-loading');
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

        try {
            // تحديث الرابط واستخدام v1beta لضمان التوافق
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `أنت خبير كتابة سير ذاتية محترف. قم بتحسين النص التالي ليكون بأسلوب جذاب واحترافي جداً باللغة ${currentLang === 'ar' ? 'العربية' : 'الإنجليزية'}. اجعل الصياغة قوية ومناسبة لـ LinkedIn: "${originalText}"`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 800,
                    }
                })
            });

            const data = await response.json();

            // فحص دقيق للرد
            if (data.error) {
                throw new Error(data.error.message);
            }

            if (data.candidates && data.candidates[0].content) {
                const improvedText = data.candidates[0].content.parts[0].text;
                field.value = improvedText.trim();
                btn.innerHTML = `<i class="fas fa-check"></i>`;
                btn.style.background = "#22c55e";
            } else {
                throw new Error("No candidates returned");
            }

        } catch (e) {
            console.error("AI Error Detail:", e);
            // تنبيه ذكي للمستخدم
            alert(currentLang === 'ar' ? 
                "عذراً، فشل الاتصال بالذكاء الاصطناعي. تأكد من اتصال الإنترنت أو صلاحية مفتاح الـ API." : 
                "AI Connection failed. Please check internet or API Key.");
            btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`;
            btn.style.background = "#ef4444";
        } finally { 
            btn.classList.remove('ai-loading'); 
            setTimeout(() => {
                btn.innerHTML = `<i class="fas fa-magic"></i> AI تحسين`;
                btn.style.background = "";
            }, 3000);
        }
    }
</script>
